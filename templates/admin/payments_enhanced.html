{% extends "base.html" %}

{% block title %}إدارة المدفوعات الشهرية المحسنة{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-money-bill-wave me-2"></i>
                        إدارة المدفوعات الشهرية المحسنة
                    </h4>
                </div>
                <div class="card-body">
                    <!-- فلاتر الشهر والسنة -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <label for="monthSelect" class="form-label">الشهر:</label>
                            <select id="monthSelect" class="form-select">
                                <option value="1" {% if current_month == 1 %}selected{% endif %}>يناير</option>
                                <option value="2" {% if current_month == 2 %}selected{% endif %}>فبراير</option>
                                <option value="3" {% if current_month == 3 %}selected{% endif %}>مارس</option>
                                <option value="4" {% if current_month == 4 %}selected{% endif %}>أبريل</option>
                                <option value="5" {% if current_month == 5 %}selected{% endif %}>مايو</option>
                                <option value="6" {% if current_month == 6 %}selected{% endif %}>يونيو</option>
                                <option value="7" {% if current_month == 7 %}selected{% endif %}>يوليو</option>
                                <option value="8" {% if current_month == 8 %}selected{% endif %}>أغسطس</option>
                                <option value="9" {% if current_month == 9 %}selected{% endif %}>سبتمبر</option>
                                <option value="10" {% if current_month == 10 %}selected{% endif %}>أكتوبر</option>
                                <option value="11" {% if current_month == 11 %}selected{% endif %}>نوفمبر</option>
                                <option value="12" {% if current_month == 12 %}selected{% endif %}>ديسمبر</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="yearSelect" class="form-label">السنة:</label>
                            <select id="yearSelect" class="form-select">
                                {% for year in range(2020, 2030) %}
                                <option value="{{ year }}" {% if current_year == year %}selected{% endif %}>{{ year }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" class="btn btn-info d-block" onclick="loadPayments()">
                                <i class="fas fa-search me-1"></i>عرض
                            </button>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" class="btn btn-success d-block" onclick="saveAllChanges()">
                                <i class="fas fa-save me-1"></i>حفظ جميع التغييرات
                            </button>
                        </div>
                    </div>

                    <!-- إحصائيات سريعة -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h5 id="paidCount">0</h5>
                                    <small>مدفوع</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-danger text-white">
                                <div class="card-body text-center">
                                    <h5 id="unpaidCount">0</h5>
                                    <small>غير مدفوع</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h5 id="totalAmount">0</h5>
                                    <small>إجمالي المحصل</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body text-center">
                                    <h5 id="expectedAmount">0</h5>
                                    <small>المبلغ المتوقع</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- جدول المدفوعات -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="paymentsTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>رقم العضو</th>
                                    <th>اسم المشترك</th>
                                    <th>القرية</th>
                                    <th>حالة الدفع</th>
                                    <th>مبلغ الدفعة</th>
                                    <th>تاريخ الدفع</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="paymentsTableBody">
                                <!-- سيتم ملء البيانات بواسطة JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal لتعديل الدفعة -->
<div class="modal fade" id="editPaymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">تعديل الدفعة</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editPaymentForm">
                    <input type="hidden" id="editMemberId">
                    <input type="hidden" id="editMonth">
                    <input type="hidden" id="editYear">
                    
                    <div class="mb-3">
                        <label for="editMemberName" class="form-label">اسم المشترك:</label>
                        <input type="text" class="form-control" id="editMemberName" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editAmount" class="form-label">مبلغ الدفعة:</label>
                        <input type="number" class="form-control" id="editAmount" step="0.01" min="0">
                    </div>
                    
                    <div class="mb-3">
                        <label for="editPaymentDate" class="form-label">تاريخ الدفع:</label>
                        <input type="date" class="form-control" id="editPaymentDate">
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editIsPaid">
                            <label class="form-check-label" for="editIsPaid">
                                مدفوع
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-primary" onclick="savePaymentEdit()">حفظ التغييرات</button>
                <button type="button" class="btn btn-danger" onclick="deletePayment()">حذف الدفعة</button>
            </div>
        </div>
    </div>
</div>

<script>
let paymentsData = [];
let hasUnsavedChanges = false;

// تحميل البيانات عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    loadPayments();
});

// تحميل المدفوعات
function loadPayments() {
    const month = document.getElementById('monthSelect').value;
    const year = document.getElementById('yearSelect').value;
    
    fetch(`/api/payments/${month}/${year}`)
        .then(response => response.json())
        .then(data => {
            paymentsData = data.payments;
            renderPaymentsTable();
            updateStatistics();
        })
        .catch(error => {
            console.error('Error loading payments:', error);
            showAlert('حدث خطأ في تحميل البيانات', 'danger');
        });
}

// عرض جدول المدفوعات
function renderPaymentsTable() {
    const tbody = document.getElementById('paymentsTableBody');
    tbody.innerHTML = '';
    
    paymentsData.forEach((payment, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${payment.member.member_number}</td>
            <td>${payment.member.name}</td>
            <td>${payment.member.village || 'غير محدد'}</td>
            <td>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" 
                           id="paid_${payment.member.id}" 
                           ${payment.is_paid ? 'checked' : ''}
                           onchange="togglePaymentStatus(${index})">
                    <label class="form-check-label" for="paid_${payment.member.id}">
                        ${payment.is_paid ? 'مدفوع' : 'غير مدفوع'}
                    </label>
                </div>
            </td>
            <td>
                <input type="number" class="form-control form-control-sm" 
                       value="${payment.amount}" 
                       step="0.01" min="0"
                       onchange="updateAmount(${index}, this.value)"
                       style="width: 120px;">
            </td>
            <td>
                <input type="date" class="form-control form-control-sm" 
                       value="${payment.payment_date || ''}"
                       onchange="updatePaymentDate(${index}, this.value)"
                       style="width: 150px;">
            </td>
            <td>
                <button class="btn btn-sm btn-outline-primary me-1" 
                        onclick="editPayment(${index})" title="تعديل">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" 
                        onclick="confirmDeletePayment(${index})" title="حذف">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// تبديل حالة الدفع
function togglePaymentStatus(index) {
    paymentsData[index].is_paid = !paymentsData[index].is_paid;
    
    // تحديث تاريخ الدفع تلقائياً
    if (paymentsData[index].is_paid && !paymentsData[index].payment_date) {
        paymentsData[index].payment_date = new Date().toISOString().split('T')[0];
    }
    
    hasUnsavedChanges = true;
    renderPaymentsTable();
    updateStatistics();
    
    // تحديث النص في الـ label
    const label = document.querySelector(`label[for="paid_${paymentsData[index].member.id}"]`);
    label.textContent = paymentsData[index].is_paid ? 'مدفوع' : 'غير مدفوع';
}

// تحديث المبلغ
function updateAmount(index, amount) {
    paymentsData[index].amount = parseFloat(amount) || 0;
    hasUnsavedChanges = true;
    updateStatistics();
}

// تحديث تاريخ الدفع
function updatePaymentDate(index, date) {
    paymentsData[index].payment_date = date;
    hasUnsavedChanges = true;
}

// تحديث الإحصائيات
function updateStatistics() {
    let paidCount = 0;
    let unpaidCount = 0;
    let totalAmount = 0;
    let expectedAmount = 0;
    
    paymentsData.forEach(payment => {
        if (payment.is_paid) {
            paidCount++;
            totalAmount += payment.amount;
        } else {
            unpaidCount++;
        }
        expectedAmount += payment.amount;
    });
    
    document.getElementById('paidCount').textContent = paidCount;
    document.getElementById('unpaidCount').textContent = unpaidCount;
    document.getElementById('totalAmount').textContent = totalAmount.toLocaleString() + ' ريال';
    document.getElementById('expectedAmount').textContent = expectedAmount.toLocaleString() + ' ريال';
}

// تعديل الدفعة
function editPayment(index) {
    const payment = paymentsData[index];
    
    document.getElementById('editMemberId').value = payment.member.id;
    document.getElementById('editMonth').value = document.getElementById('monthSelect').value;
    document.getElementById('editYear').value = document.getElementById('yearSelect').value;
    document.getElementById('editMemberName').value = payment.member.name;
    document.getElementById('editAmount').value = payment.amount;
    document.getElementById('editPaymentDate').value = payment.payment_date || '';
    document.getElementById('editIsPaid').checked = payment.is_paid;
    
    const modal = new bootstrap.Modal(document.getElementById('editPaymentModal'));
    modal.show();
}

// حفظ تعديل الدفعة
function savePaymentEdit() {
    const memberId = document.getElementById('editMemberId').value;
    const amount = parseFloat(document.getElementById('editAmount').value) || 0;
    const paymentDate = document.getElementById('editPaymentDate').value;
    const isPaid = document.getElementById('editIsPaid').checked;
    
    // العثور على الدفعة في البيانات وتحديثها
    const index = paymentsData.findIndex(p => p.member.id == memberId);
    if (index !== -1) {
        paymentsData[index].amount = amount;
        paymentsData[index].payment_date = paymentDate;
        paymentsData[index].is_paid = isPaid;
        
        hasUnsavedChanges = true;
        renderPaymentsTable();
        updateStatistics();
    }
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('editPaymentModal'));
    modal.hide();
    
    showAlert('تم تحديث الدفعة بنجاح', 'success');
}

// تأكيد حذف الدفعة
function confirmDeletePayment(index) {
    if (confirm('هل أنت متأكد من حذف هذه الدفعة؟')) {
        deletePaymentByIndex(index);
    }
}

// حذف الدفعة
function deletePaymentByIndex(index) {
    const payment = paymentsData[index];
    
    // إعادة تعيين الدفعة إلى القيم الافتراضية
    payment.is_paid = false;
    payment.amount = 1000; // القيمة الافتراضية
    payment.payment_date = '';
    
    hasUnsavedChanges = true;
    renderPaymentsTable();
    updateStatistics();
    
    showAlert('تم حذف الدفعة بنجاح', 'success');
}

// حذف الدفعة من المودال
function deletePayment() {
    const memberId = document.getElementById('editMemberId').value;
    const index = paymentsData.findIndex(p => p.member.id == memberId);
    
    if (index !== -1) {
        deletePaymentByIndex(index);
    }
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('editPaymentModal'));
    modal.hide();
}

// حفظ جميع التغييرات
function saveAllChanges() {
    if (!hasUnsavedChanges) {
        showAlert('لا توجد تغييرات للحفظ', 'info');
        return;
    }
    
    const month = document.getElementById('monthSelect').value;
    const year = document.getElementById('yearSelect').value;
    
    fetch('/api/payments/save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            month: parseInt(month),
            year: parseInt(year),
            payments: paymentsData
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            hasUnsavedChanges = false;
            showAlert('تم حفظ جميع التغييرات بنجاح', 'success');
        } else {
            showAlert('حدث خطأ في حفظ البيانات: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error saving payments:', error);
        showAlert('حدث خطأ في حفظ البيانات', 'danger');
    });
}

// عرض التنبيهات
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    // إزالة التنبيه تلقائياً بعد 5 ثوان
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// تحذير عند مغادرة الصفحة مع وجود تغييرات غير محفوظة
window.addEventListener('beforeunload', function(e) {
    if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = '';
    }
});
</script>

<style>
.form-check-input:checked {
    background-color: #28a745;
    border-color: #28a745;
}

.table th {
    background-color: #343a40;
    color: white;
    border-color: #454d55;
}

.card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.btn-outline-primary:hover {
    transform: translateY(-1px);
}

.btn-outline-danger:hover {
    transform: translateY(-1px);
}

.alert {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1050;
    min-width: 300px;
}

.form-control-sm {
    font-size: 0.875rem;
}

.table-responsive {
    border-radius: 0.375rem;
}
</style>
{% endblock %}

